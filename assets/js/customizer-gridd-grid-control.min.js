wp.customize.controlConstructor.gridd_grid=wp.customize.Control.extend({gridVal:{rows:4,columns:3,areas:{content:{cells:[[1,1],[1,2],[2,1],[2,2]]}},gridTemplate:{rows:{},columns:{}}},cellsNr:1,selectedCells:[],editingPart:!1,dragSelect:{},ready:function(){var e=this;this.gridVal=_.defaults(e.setting._value,e.gridVal),this.drawGrid=_.debounce(_.bind(this.drawGridSelector,this),50),this.drawPreview=_.debounce(_.bind(this.drawGridSelectedParts,this),50),this.save=_.debounce(_.bind(this.saveValue,this),100),_.isArray(this.gridVal.areas)&&(this.gridVal.areas={}),this.sanitizeGridVal(),this.cellsNr=e.gridVal.rows*e.gridVal.columns,e.drawGrid(),e.drawPreview(),e.gridButtons(),e.selectPartButtons(),e.setPartsFromAllGridControls()},gridButtons:function(){var r=this;r.container.find(".button.add-column").on("click",function(e){r.addColumn(),e.preventDefault()}),r.container.find(".button.remove-column").on("click",function(e){r.removeColumn(),e.preventDefault()}),r.container.find(".button.add-row").on("click",function(e){r.addRow(),e.preventDefault()}),r.container.find(".button.remove-row").on("click",function(e){r.removeRow(),e.preventDefault()}),r.container.find(".gridd-grid-zoom-in").on("click",function(e){})},getMaxColsRowsFromActiveParts:function(){var r=1,t=1;return _.each(this.gridVal.areas,function(e){_.each(e.cells,function(e){e[0]>t&&(t=e[0]),e[1]>r&&(r=e[1])})}),[t,r]},addColumn:function(){var e=this;e.gridVal.columns++,e.drawGrid(),e.drawPreview(),e.save()},removeColumn:function(){var e=this,r=e.getMaxColsRowsFromActiveParts();e.gridVal.columns-1>=r[1]&&(e.gridVal.columns--,e.drawGrid(),e.drawPreview(),e.save())},addRow:function(){var e=this;e.gridVal.rows++,e.drawGrid(),e.drawPreview(),e.save()},removeRow:function(){var e=this,r=e.getMaxColsRowsFromActiveParts();e.gridVal.rows-1>=r[0]&&(e.gridVal.rows--,e.drawGrid(),e.drawPreview(),e.save())},drawGridSelector:function(){var e,r,t=this,i=t.container.find(".gridd-grid-selectable");for(i.empty(),this.sanitizeGridVal(),e=1;e<=t.gridVal.rows;e++)for(r=1;r<=t.gridVal.columns;r++)i.append('<button class="gridd-grid-selectable-cell" data-row="'+e+'" data-column="'+r+'"><span class="screen-reader-text">Row '+e+", Column "+r+"</span></button>");t.dragSelect=new DragSelect({selectables:document.getElementById("customize-control-"+t.id).getElementsByClassName("gridd-grid-selectable-cell"),area:document.getElementById("gridd-grid-selectable-"+t.id),callback:function(e){t.selectedCells=[],_.each(e,function(e){t.container.find(e).data("row")&&t.container.find(e).data("column")&&t.selectedCells.push([t.container.find(e).data("row"),t.container.find(e).data("column")])}),t.selectedCells.length&&(t.editingPart?(t.gridVal.areas[t.editingPart].cells=t.selectedCells,t.setPartsFromAllGridControls(),t.save(),t.drawPreview()):(t.drawGridSelectedParts(),t.container.find(".gridd-grid-part-selector").css("display","block"))),setTimeout(function(){t.container.find(".edit-part-options-done").click()},250)}}),t.container.find(".gridd-grid-selectable-cell").on("click",function(e){e.preventDefault()}),i.css("grid-template-columns","repeat("+t.gridVal.columns+", 1fr)"),i.css("grid-template-rows","repeat("+t.gridVal.rows+", 65px)"),t.container.find(".gridd-grid-builder-grids").height(i.height()+30),this.sanitizeGridVal(),t.drawColumnFields(),t.drawRowFields()},drawColumnFields:function(){var e,r=this,t=r.container.find(".gridd-grid-builder-columns");for(t.html(""),e=0;e<r.gridVal.columns;e++)_.isUndefined(r.gridVal.gridTemplate.columns[e])&&(r.gridVal.gridTemplate.columns[e]="auto",r.save()),t.append('<input type="text" data-column-css="'+e+'" value="'+r.gridVal.gridTemplate.columns[e]+'">');t.css("grid-template-columns","repeat("+r.gridVal.columns+", 1fr)"),this.sanitizeGridVal(),r.container.find("[data-column-css]").on("change keyup paste",function(){r.gridVal.gridTemplate.columns[jQuery(this).data("column-css")]=jQuery(this).val(),r.save()}),this.sanitizeGridVal()},drawRowFields:function(){var e,r=this,t=r.container.find(".gridd-grid-builder-rows");for(this.sanitizeGridVal(),t.html(""),e=0;e<r.gridVal.rows;e++)_.isUndefined(r.gridVal.gridTemplate.rows[e])&&(r.gridVal.gridTemplate.rows[e]="auto",r.save()),t.append('<input type="text" data-row-css="'+e+'" value="'+r.gridVal.gridTemplate.rows[e]+'">');t.css("grid-template-rows","repeat("+r.gridVal.rows+", 1fr)"),r.container.find("[data-row-css]").on("change keyup paste",function(){r.gridVal.gridTemplate.rows[jQuery(this).data("row-css")]=jQuery(this).val(),r.save()}),this.sanitizeGridVal()},drawGridSelectedParts:function(){var o=this,c=o.container.find(".gridd-grid-selected"),e=o.getPartsFromAllGridControls();c.empty(),o.setPartsFromAllGridControls(),o.container.find(".gridd-grid-part-selector .grid-part-select option").removeAttr("disabled"),o.container.find('.gridd-grid-part-selector .grid-part-select option[value=""]').attr("selected",!0),_.each(_.keys(e),function(e){o.params.choices.duplicate&&window.griddGridPartsSelectedAreas[o.params.choices.duplicate]&&_.contains(window.griddGridPartsSelectedAreas[o.params.choices.duplicate],e)||o.container.find('.gridd-grid-part-selector .grid-part-select option[value="'+e+'"]').attr("disabled",!0)}),this.sanitizeGridVal(),_.each(o.gridVal.areas,function(e,r){var t,i,a,d,n,s=[],l=[];o.container.find('.gridd-grid-part-selector .grid-part-select option[value="'+r+'"]').attr("disabled",!0),e.cells&&!_.isEmpty(e.cells)&&(_.each(e.cells,function(e){s.push(e[0]),l.push(e[1]),t=_.min(s),i=_.max(s)+1,a=_.min(l),d=_.max(l)+1}),n='<div class="grid-selected-part selected-part-'+r+'" style="grid-row-start:'+t+";grid-row-end:"+i+";grid-column-start:"+a+";grid-column-end:"+d+';">',n+='<span class="inner" style="background-color:'+o.getPartAttr(r,"color")[0]+";color:"+o.getPartAttr(r,"color")[1]+';">',n+='<span class="part-label-wrapper">'+o.getPartAttr(r,"label")+"</span>",n+=o.getActionsHTML(r),n+="</span>",n+="</div>",c.append(n))}),o.editingPart?(o.container.find(".gridd-grid-builder-grids").addClass("editing-parts"),o.container.find(".gridd-grid-builder-grids-wrapper").addClass("editing-parts"),o.container.find(".grid-selected-part.selected-part-"+o.editingPart).addClass("editing")):(o.container.find(".gridd-grid-builder-grids").removeClass("editing-parts"),o.container.find(".gridd-grid-builder-grids-wrapper").removeClass("editing-parts")),c.css("grid-template-columns","repeat("+o.gridVal.columns+", 1fr)"),c.css("grid-template-rows","repeat("+o.gridVal.rows+", 65px)"),o.trggerPartEditButton(),o.triggerPartDeleteButton(),o.triggerFocusButtons()},triggerFocusButtons:function(){this.container.find(".button-gridd-focus").on("click",function(e){var r=jQuery(this).data("part"),t=r;wp.customize.section(r)&&(t=wp.customize.section.part),"header_branding"===r&&(t="title_tagline"),wp.customize.section(t).focus(),e.preventDefault()})},getActionsHTML:function(e){var r,t=this,i='<button class="resize" data-part="'+e+'" title="'+griddGridControl.l10n.resize+'"><svg style="width:15px;height:15px;" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><path d="M237.113 447.502h6.55V512c-10.939 0-22.015-.096-32.111-3.938-22.511-8.565-38.703-31.568-38.935-56.08l-.001-10.013h64.497v5.533zM372.658 512H308.16v-64.498h64.498V512zM512 451.648c-.1 30.959-26.55 60.025-60.018 60.351l-14.827.001v-64.498h10.347v-1.736H512v5.882zm0-70.379h-64.498v-64.498H512v64.498zm-339.384-41.536c-37.475.004-74.951-.055-112.425-.177C29.092 339.262.486 312.519.174 279.538c-.232-73.115-.232-146.231 0-219.346C.467 29.17 27.21.488 60.191.174c73.115-.232 146.232-.232 219.348 0 31.076.296 59.7 27.03 60.017 60.017.116 37.474.173 74.95.169 112.425h27.104v64.497h-27.167c-.027 14.142-.062 28.284-.106 42.426-.299 31.151-27.101 59.706-60.017 60.017-14.142.046-28.284.083-42.426.111v37.804h-64.497v-37.738zM275.06 64.67H64.67v210.39h210.39V64.67zM512 252.274h-64.498v-15.161h-16.176v-64.497c6.886 0 13.771-.02 20.656.001 31.122.299 59.706 27.163 60.017 60.016l.001 19.641z"/></svg><span class="screen-reader-text">'+griddGridControl.l10n.resize+"</span></button>",a=(griddGridControl.l10n.edit,griddGridControl.l10n.edit,'<button class="delete" data-part="'+e+'" title="'+griddGridControl.l10n.delete+'"><span class="trash dashicons dashicons-trash"></span><span class="screen-reader-text">'+griddGridControl.l10n.delete+"</span></button>");return"content"!==e&&"header"!==e&&"footer"!==e||(a=""),r='<div class="actions">',t.params.choices.disablePartButtons&&t.params.choices.disablePartButtons.indexOf("edit"),t.params.choices.disablePartButtons&&-1!==t.params.choices.disablePartButtons.indexOf("resize")||(r+=i),t.params.choices.disablePartButtons&&-1!==t.params.choices.disablePartButtons.indexOf("delete")||(r+=a),r+="</div>"},selectPartButtons:function(){var t=this;t.container.find(".gridd-grid-part-selector .grid-part-select").on("change",function(e){var r;e.preventDefault(),t.sanitizeGridVal(),t.selectedCells&&(r=jQuery(this).val(),t.gridVal.areas[r]=t.gridVal.areas[r]||{},t.gridVal.areas[r].cells=t.selectedCells,t.save()),t.sanitizeGridVal(),t.setPartsFromAllGridControls(),t.drawPreview(),t.dragSelect.clearSelection(),t.container.find(".gridd-grid-part-selector").css("display","none")}),t.container.find(".gridd-grid-part-selector-cancel").on("click",function(e){t.container.find(".gridd-grid-part-selector").css("display","none"),t.dragSelect.clearSelection(),e.preventDefault()})},trggerPartEditButton:function(){var i=this,a=document.getElementsByClassName("gridd-grid-selectable-cell");i.container.find(".grid-selected-part .actions .resize").on("click",function(e){var t=[],r=jQuery(this).data("part");i.editingPart=r,e.preventDefault(),i.container.find(".grid-selected-part").addClass("editing"),t=[],i.sanitizeGridVal(),i.gridVal.areas[r]&&i.gridVal.areas[r].cells&&_.each(i.gridVal.areas[r].cells,function(r){_.each(a,function(e){r[0]===parseInt(e.dataset.row,10)&&r[1]===parseInt(e.dataset.column,10)&&t.push(e)})}),i.sanitizeGridVal(),i.drawPreview(),i.dragSelect.setSelection(t)}),i.container.find(".edit-part-options-done").on("click",function(e){i.editingPart="",e.preventDefault(),i.container.find(".grid-selected-part").removeClass("editing"),i.container.find(".gridd-grid-builder-grids").removeClass("editing-parts"),i.container.find(".gridd-grid-builder-grids-wrapper").removeClass("editing-parts"),i.dragSelect.clearSelection()})},triggerPartDeleteButton:function(){var t=this;t.container.find(".grid-selected-part .actions .delete").on("click",function(e){var r=jQuery(this).data("part");e.preventDefault(),delete t.gridVal.areas[r],t.sanitizeGridVal(),t.setPartsFromAllGridControls(),t.save(),t.drawPreview(),setTimeout(function(){t.container.find(".edit-part-options-done").click()},250)})},getPartAttr:function(r,t){var i="";return _.each(this.params.choices.parts,function(e){e[t]&&r===e.id&&(i=e[t])}),i},setPartsFromAllGridControls:function(){window.griddGridPartsSelectedAreas||(window.griddGridPartsSelectedAreas={}),window.griddGridPartsSelectedAreas[this.id]=_.keys(this.gridVal.areas)},getPartsFromAllGridControls:function(){var t=this,i={};return window.griddGridPartsSelectedAreas||(window.griddGridPartsSelectedAreas={}),_.each(window.griddGridPartsSelectedAreas.gridd_grid,function(e){var r=t.getSubPartsFromGridControl(e);i[e]=!0,r&&(i=jQuery.extend({},i,r))}),i},getSubPartsFromGridControl:function(e){var r=griddGridControl.nestedParts[e],t=window.griddGridPartsSelectedAreas[e],i={};return r&&window.griddGridPartsSelectedAreas[r]?this.getSubPartsFromGridControl(r):!(!t||!_.isArray(t))&&(_.each(t,function(e){i[e]=!0}),i)},sanitizeGridVal:function(){var i=this,a=[];_.each(i.params.choices.parts,function(e){a.push(e.id)}),i.gridVal.rows=parseInt(i.gridVal.rows,10),i.gridVal.columns=parseInt(i.gridVal.columns,10),_.each(i.gridVal.areas,function(e,r){var t=[];_.each(e.cells,function(e){t.push([parseInt(e[0],10),parseInt(e[1],10)])}),-1<a.indexOf(r)?i.gridVal.areas[r].cells=t:delete i.gridVal.areas[r]})},saveValue:function(){var e;this.sanitizeGridVal(),e=jQuery.extend({},this.gridVal),this.setPartsFromAllGridControls(),this.container.find(".gridd-grid-hidden-value").attr("value",JSON.stringify(e)).trigger("change")}});